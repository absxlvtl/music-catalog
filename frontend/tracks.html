<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>Music Catalog â€” Tracks</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #tracks li { padding: 6px; border-bottom: 1px solid #ddd; }
    #degraded { margin-bottom: 16px; }
    button { padding: 8px 14px; margin: 5px 0; }
  </style>
</head>
<body>

  <h1>ðŸŽµ Music Catalog â€” Tracks</h1>

  <button id="load">Load Tracks</button>
  <button id="create">Create Test Track</button>

  <ul id="tracks"></ul>

  <script type="module">
    import { fetchWithResilience } from "./lib/http.js";
    import { getOrReuseKey } from "./lib/idempotency.js";
    import { DegradedMode } from "./lib/degraded.js";

    const DM = new DegradedMode(3);
    const API = "http://localhost:8081/tracks";

    const list = document.getElementById("tracks");
    const loadBtn = document.getElementById("load");
    const createBtn = document.getElementById("create");

    async function loadTracks() {
      try {
        const res = await fetchWithResilience(API, { method: "GET" });
        DM.reset();
        const data = await res.json();

        list.innerHTML = "";
        data.items.forEach(t => {
          const li = document.createElement("li");
          li.textContent = `${t.id}: ${t.title} â€” ${t.artist}`;
          list.appendChild(li);
        });
      } catch (err) {
        DM.registerFailure();
        console.log("load error:", err);
      }
    }

    async function createTrack() {
      const payload = { title: "New Track", artist: "Unknown Artist" };
      const key = await getOrReuseKey(payload);

      try {
        const res = await fetchWithResilience(API, {
          method: "POST",
          body: JSON.stringify(payload),
          idempotencyKey: key
        });
        DM.reset();
        await loadTracks();
      } catch (err) {
        DM.registerFailure();
        console.log("create error:", err);
      }
    }

    loadBtn.onclick = loadTracks;
    createBtn.onclick = createTrack;

  </script>

</body>
</html>
